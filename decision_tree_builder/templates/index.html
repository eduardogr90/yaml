<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Decision Tree Builder</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  </head>
  <body
    class="page-editor page-workspace {{ 'is-viewing' if active_flow else 'is-idle' }}"
    data-active-project="{{ active_project.id if active_project }}"
    data-active-flow="{{ active_flow.id if active_flow }}"
  >
    <div class="workspace-app">
      <aside class="projects-panel" id="projects-panel" aria-hidden="false">
        <header class="projects-panel__header">
          <h1 class="projects-panel__title">Decision Tree Builder</h1>
        </header>

        <section class="projects-panel__section">
          <h2 class="section-title">Nombre</h2>
          <form
            method="post"
            action="{{ url_for('create_project') }}"
            class="project-search"
            id="create-project-form"
          >
            <div class="project-search__control">
              <input
                type="text"
                id="project-search-input"
                name="project_name"
                required
                placeholder="Nombre del proyecto"
                autocomplete="off"
              />
              <input type="hidden" name="project_description" value="" />
              <button type="submit" class="project-search__create" aria-label="Crear proyecto">
                <span aria-hidden="true">+</span>
              </button>
            </div>
          </form>
        </section>

        <nav class="projects-panel__section project-tree">
          <h2 class="section-title">Proyectos y flujos</h2>
          <ul class="project-tree__list" id="project-tree">
            {% if not projects %}
              <li class="project-tree__empty">TodavÃ­a no hay proyectos. Â¡Crea el primero!</li>
            {% endif %}
            {% for project in projects %}
              {% set is_active_project = active_project and active_project.id == project.id %}
              <li
                class="project-tree__project {{ 'is-active' if is_active_project }}"
                data-project-id="{{ project.id }}"
                data-search-text="{{ (project.name or '')|lower }}"
              >
                <details class="project-branch" {% if is_active_project %}open{% endif %}>
                  <summary>
                    <div class="project-branch__header">
                      <div class="project-branch__display">
                        <span
                          class="project-branch__name editable-label"
                          data-rename-form="rename-project-{{ project.id }}"
                          title="Doble clic para renombrar"
                        >
                          {{ project.name }}
                        </span>
                        <div class="project-branch__actions">
                          <form
                            method="post"
                            action="{{ url_for('create_flow', project_id=project.id) }}"
                            class="inline-form create-flow-form"
                          >
                            <input type="hidden" name="flow_name" value="" />
                            <input type="hidden" name="flow_description" value="" />
                            <button
                              type="button"
                              class="icon-button create-flow-button"
                              aria-label="Crear flujo en {{ project.name }}"
                              title="Crear flujo"
                            >
                              +
                            </button>
                          </form>
                          <form
                            method="post"
                            action="{{ url_for('delete_project', project_id=project.id) }}"
                            class="inline-form"
                            data-confirm="Â¿Eliminar el proyecto {{ project.name }}? Esta acciÃ³n es irreversible."
                          >
                            <button
                              type="submit"
                              class="icon-button danger"
                              aria-label="Eliminar proyecto {{ project.name }}"
                              title="Eliminar proyecto"
                            >
                              ðŸ—‘
                            </button>
                          </form>
                        </div>
                      </div>
                      <form
                        id="rename-project-{{ project.id }}"
                        class="rename-form inline-rename"
                        method="post"
                        action="{{ url_for('rename_project', project_id=project.id) }}"
                      >
                        <label class="sr-only" for="project-name-{{ project.id }}">Nombre del proyecto</label>
                        <input
                          id="project-name-{{ project.id }}"
                          type="text"
                          name="project_name"
                          value="{{ project.name }}"
                          required
                          class="inline-rename__input"
                        />
                        <input type="hidden" name="project_description" value="" />
                        <div class="rename-form__actions inline-rename__actions">
                          <button type="submit" class="btn primary">Guardar</button>
                          <button type="button" class="btn secondary" data-action="cancel-rename">Cancelar</button>
                        </div>
                      </form>
                    </div>
                  </summary>

                  <ul class="project-branch__flows">
                    {% if not project.flows %}
                      <li class="project-branch__empty">AÃºn no hay flujos en este proyecto.</li>
                    {% else %}
                      {% for flow in project.flows %}
                        {% set is_active_flow = is_active_project and active_flow and active_flow.id == flow.id %}
                        <li
                          class="project-flow {{ 'is-active' if is_active_flow }}"
                          data-flow-id="{{ flow.id }}"
                          data-search-text="{{ (flow.name or '')|lower }}"
                        >
                          <div class="project-flow__main">
                            <div class="project-flow__display">
                              <button
                                type="button"
                                class="project-flow__select"
                                data-href="{{ url_for('index', project=project.id, flow=flow.id) }}"
                                data-ensure-clean="true"
                              >
                                <span
                                  class="project-flow__name editable-label"
                                  data-rename-form="rename-flow-{{ project.id }}-{{ flow.id }}"
                                  title="Doble clic para renombrar"
                                >
                                  {{ flow.name }}
                                </span>
                              </button>
                              <div class="project-flow__actions">
                                <form
                                  method="post"
                                  action="{{ url_for('delete_flow', project_id=project.id, flow_id=flow.id) }}"
                                  class="inline-form"
                                  data-confirm="Â¿Eliminar el flujo {{ flow.name }}?"
                                >
                                  <button
                                    type="submit"
                                    class="icon-button danger"
                                    aria-label="Eliminar flujo {{ flow.name }}"
                                    title="Eliminar flujo"
                                  >
                                    ðŸ—‘
                                  </button>
                                </form>
                              </div>
                            </div>
                            <form
                              id="rename-flow-{{ project.id }}-{{ flow.id }}"
                              class="rename-form inline-rename"
                              method="post"
                              action="{{ url_for('rename_flow', project_id=project.id, flow_id=flow.id) }}"
                            >
                              <div class="inline-rename__field">
                                <label class="sr-only" for="flow-name-{{ project.id }}-{{ flow.id }}">Nombre del flujo</label>
                                <input
                                  id="flow-name-{{ project.id }}-{{ flow.id }}"
                                  type="text"
                                  name="flow_name"
                                  value="{{ flow.name }}"
                                  required
                                  class="inline-rename__input"
                                />
                              </div>
                              <div class="inline-rename__field">
                                <label class="sr-only" for="flow-description-{{ project.id }}-{{ flow.id }}">DescripciÃ³n del flujo</label>
                                <textarea
                                  id="flow-description-{{ project.id }}-{{ flow.id }}"
                                  name="flow_description"
                                  rows="2"
                                  class="inline-rename__textarea"
                                >{{ flow.description }}</textarea>
                              </div>
                              <div class="rename-form__actions inline-rename__actions">
                                <button type="submit" class="btn primary">Guardar</button>
                                <button type="button" class="btn secondary" data-action="cancel-rename">Cancelar</button>
                              </div>
                            </form>
                          </div>
                        </li>
                      {% endfor %}
                    {% endif %}
                  </ul>
                </details>
              </li>
            {% endfor %}
            <li class="project-tree__empty project-tree__empty--search" hidden>
              No se encontraron proyectos con ese nombre.
            </li>
          </ul>
        </nav>
      </aside>

      <button
        type="button"
        class="sidebar-toggle"
        id="btn-toggle-projects"
        aria-controls="projects-panel"
        aria-expanded="true"
      >
        Ocultar panel de proyectos
      </button>

      <main class="workspace-main">
        <header class="editor-header">
          <div class="header-top"></div>
          {% if not active_flow %}
            <p class="editor-intro">
              Selecciona un flujo para comenzar a editarlo o crea un nuevo flujo con el botÃ³n Â«+Â».
            </p>
          {% endif %}
          {% if active_flow %}
            <div class="editor-toolbar" aria-hidden="true">
              <div class="toolbar-section toolbar-section--actions">
                <div class="toolbar-buttons">
                  <button
                    type="button"
                    class="btn danger"
                    id="btn-cancel-edit"
                    data-href="{{ url_for('index', project=active_project.id) }}"
                  >
                    Cancelar
                  </button>
                  <button type="button" class="btn success" id="btn-save">Guardar flujo (Ctrl+S)</button>
                  <button type="button" class="btn secondary" id="btn-export-yaml" title="YAML Out (Ctrl+E)">
                    YAML Out
                  </button>
                  <button type="button" class="btn secondary" id="btn-import-yaml">YAML In</button>
                </div>
              </div>
              <div class="toolbar-section toolbar-section--nodes">
                <span class="toolbar-label">Agregar nodos</span>
                <div class="toolbar-buttons">
                  <button type="button" class="btn primary" data-node-type="question">Agregar pregunta</button>
                  <button type="button" class="btn primary" data-node-type="message">Agregar mensaje</button>
                </div>
              </div>
            </div>
          {% endif %}
        </header>

        <div class="editor-layout">
          {% if active_flow %}
            <section class="workspace">
              <div id="drawflow" class="drawflow-container">
                <div id="workspace">
                  <svg id="connection-layer"></svg>
                  <div id="nodes-layer"></div>
                </div>
                <div class="drawflow-controls">
                  <button
                    type="button"
                    class="drawflow-control"
                    id="btn-toggle-edit"
                    aria-pressed="false"
                    title="Activar ediciÃ³n"
                  >
                    Editar
                  </button>
                  <button
                    type="button"
                    class="drawflow-control"
                    id="btn-toggle-fullscreen"
                    aria-pressed="false"
                  >
                    Pantalla completa
                  </button>
                </div>
              </div>
            </section>
            <div
              class="panel-resizer"
              role="separator"
              aria-label="Redimensionar panel de propiedades"
              aria-orientation="vertical"
              data-panel="properties"
            ></div>
            <aside class="properties" id="properties-panel" aria-hidden="false">
              <header class="properties__header">
                <h3>Propiedades del nodo</h3>
                <button
                  type="button"
                  class="properties__collapse"
                  id="btn-hide-properties"
                  aria-controls="properties-panel"
                  aria-expanded="true"
                >
                  Ocultar
                </button>
              </header>
              <div id="properties-content">
                <p class="empty">Selecciona un nodo para editar sus propiedades.</p>
              </div>
            </aside>
            <button
              type="button"
              class="properties-toggle"
              id="btn-toggle-properties"
              aria-controls="properties-panel"
              aria-expanded="true"
            >
              Ocultar panel de propiedades
            </button>
          {% else %}
            <section class="workspace workspace--empty">
              <div class="workspace-placeholder">
                <h2>Editor de flujos</h2>
                <p>Selecciona un flujo desde el panel lateral para visualizarlo y editarlo.</p>
                <p>Puedes crear nuevos flujos con el botÃ³n Â«+Â» dentro de cada proyecto.</p>
              </div>
            </section>
          {% endif %}
        </div>

        <div id="status-bar" class="status-bar">
          {{ 'Flujo cargado.' if active_flow else 'Sin flujo seleccionado.' }}
        </div>

        {% if active_flow %}
          <div id="modal" class="modal hidden">
            <div class="modal-content">
              <header class="modal-header">
                <h3 id="modal-title">Resultado</h3>
                <button type="button" id="modal-close" class="btn secondary">Cerrar</button>
              </header>
              <div id="modal-body" class="modal-body"></div>
            </div>
          </div>
        {% endif %}
      </main>
    </div>

    <script src="{{ url_for('static', filename='js/workspace.js') }}"></script>
    {% if active_flow %}
      <script>
        window.APP_CONFIG = {
          projectId: {{ active_project.id|tojson }},
          projectName: {{ active_project.name|tojson }},
          flowId: {{ active_flow.id|tojson }},
          flowName: {{ active_flow.name|tojson }},
          flowDescription: {{ active_flow.description|tojson }},
          flowData: {{ flow_data|safe }}
        };
      </script>
      <script src="{{ url_for('static', filename='js/drawflow.min.js') }}"></script>
      <script src="{{ url_for('static', filename='js/html2canvas.js') }}"></script>
      <script src="{{ url_for('static', filename='js/editor.js') }}"></script>
    {% endif %}
    <script>
      document.querySelectorAll('form[data-confirm]').forEach((form) => {
        form.addEventListener('submit', (event) => {
          const message = form.dataset.confirm || 'Â¿Confirmar acciÃ³n?';
          if (!window.confirm(message)) {
            event.preventDefault();
          }
        });
      });
    </script>
  </body>
</html>
